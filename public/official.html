<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Official Chat</title>
  <style>
    body{font-family:Arial; margin:20px;}
    .messages{
        border:1px solid #ccc;
        height:400px;
        overflow-y:scroll;
        padding:5px;
        margin-bottom:10px;
    }
    input{width:70%; padding:5px;}
    button{padding:5px 10px;}
  </style>
</head>

<body>

<script>
// üîê HARD LOGIN PROTECTION (RUNS FIRST)

const TOKEN = localStorage.getItem("JWT_TOKEN");
const DEPT  = localStorage.getItem("DEPARTMENT");

if(!TOKEN || !DEPT){
    alert("Session expired. Please login again.");
    window.location.href="login.html";
}
</script>


<h2>Official Chat</h2>
<button onclick="logout()">Logout</button><br><br>
<hr>

<h3>Check Citizen Conversation</h3>

<input type="text" id="checkReplyToken"
       placeholder="Enter Reply Token to view conversation"
       style="width:70%; padding:5px;">

<button onclick="loadConversation()">Load Messages</button>

<br><br>

<div class="messages" id="messages"></div>

<label>Reply Token:</label>
<input id="replyTokenInput" placeholder="Enter reply token here..." style="width:70%; padding:5px;">
<br><br>

<input id="msg" placeholder="Reply to citizen...">
<button onclick="sendMessage()">Send</button>



<script src="js/crypto-js.js"></script>

<script>

let ws;
let currentReplyToken = null;
const AES_KEY = "my_secret_key_123";

// ‚úÖ WebSocket connection
//ws = new WebSocket(`ws://${location.host}/official?token=${TOKEN}&dept=${DEPT}`);
const protocol = location.protocol === "https:" ? "wss:" : "ws:";
ws = new WebSocket(`${protocol}//${location.host}/official?token=${TOKEN}&dept=${DEPT}`);


ws.onopen = () => {
    console.log("‚úÖ Connected as official");
};

// ws.onmessage = (e) => {

//     const msg = JSON.parse(e.data);

//     // Only handle citizen ‚Üí official
//     if(msg.chatType !== "cto") return;

//     const messagesEl = document.getElementById("messages");

//     let text = msg.message;

//     // Try decrypt
//     try{
//         const bytes = CryptoJS.AES.decrypt(text, AES_KEY);
//         const decrypted = bytes.toString(CryptoJS.enc.Utf8);
//         if(decrypted) text = decrypted;
//     }catch{}

//     messagesEl.innerHTML += `
//         <b>[${msg.department}] Citizen:</b> ${text}<br>
//         <small>Reply Token: ${msg.replyToken}</small><br><br>
//     `;

//     messagesEl.scrollTop = messagesEl.scrollHeight;

//     currentReplyToken = msg.replyToken; // select latest
// };

ws.onmessage = (e) => {

    const msg = JSON.parse(e.data);

    // Only handle cto or otc
    //if(msg.chatType !== "cto" && msg.chatType !== "otc") return;

    const messagesEl = document.getElementById("messages");
    // ======================
// üü£ LOAD FULL HISTORY
// ======================
if(msg.chatType === "history"){

    messagesEl.innerHTML = "";

    if(!msg.messages || msg.messages.length === 0){
        messagesEl.innerHTML = "<b>No conversation found for this token.</b>";
        return;
    }

    msg.messages.forEach(m => {

        let text = m.message;

        try{
            const bytes = CryptoJS.AES.decrypt(text, AES_KEY);
            const decrypted = bytes.toString(CryptoJS.enc.Utf8);
            if(decrypted) text = decrypted;
        }catch{}

        messagesEl.innerHTML += `
            <b>${m.from === "citizen" ? "Citizen" : "You"}:</b>
            ${text}
            <br><small>
            (${new Date(m.timestamp).toLocaleTimeString()})
            </small><br><br>
        `;
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
    return;
}


    let text = msg.message;

    // Try decrypt
    try{
        const bytes = CryptoJS.AES.decrypt(text, AES_KEY);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        if(decrypted) text = decrypted;
    }catch{}

    // üîµ Citizen ‚Üí Official
    if(msg.chatType === "cto"){

    messagesEl.innerHTML += `
        <b>[${msg.department}] Citizen:</b> ${text}<br>
        <small>Reply Token: ${msg.replyToken}</small><br><br>
    `;

    currentReplyToken = msg.replyToken;

    // ‚úÖ Auto-fill input field
    const tokenInput = document.getElementById("replyTokenInput");
    if(tokenInput) tokenInput.value = msg.replyToken;
}

    // üü¢ Official ‚Üí Citizen (show own reply)
    if(msg.chatType === "otc"){

    messagesEl.innerHTML += `
        <b>You [${msg.department}]</b>: ${text}
        <span style="color:gray;font-size:0.8em;">
        (${new Date(msg.timestamp).toLocaleTimeString()})
        </span><br><br>
    `;
}

    messagesEl.scrollTop = messagesEl.scrollHeight;
};

function sendMessage(){

    const input = document.getElementById("msg");
    const tokenInput = document.getElementById("replyTokenInput");

    const manualToken = tokenInput.value.trim();

    if(!input.value.trim())
        return alert("Enter a message!");

    if(!manualToken)
        return alert("Enter a Reply Token!");

    const encrypted = CryptoJS.AES.encrypt(input.value, AES_KEY).toString();

    ws.send(JSON.stringify({
        chatType: "otc",
        replyToken: manualToken,   // ‚úÖ use manual field
        department: DEPT,
        message: encrypted,
        timestamp: Date.now()
    }));

    input.value="";
}
function loadConversation(){

    const tokenInput = document.getElementById("checkReplyToken");

    if(!tokenInput || !tokenInput.value.trim())
        return alert("Enter a Reply Token!");

    const enteredToken = tokenInput.value.trim();

    currentReplyToken = enteredToken;

    ws.send(JSON.stringify({
        chatType: "loadHistory",
        department: DEPT,
        replyToken: enteredToken
    }));
}



function logout(){
    localStorage.removeItem("JWT_TOKEN");
    localStorage.removeItem("DEPARTMENT");
    if(ws) ws.close();
    window.location.href="login.html";
}

</script>

</body>
</html>
