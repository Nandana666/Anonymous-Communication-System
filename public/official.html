<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Official Chat</title>
  <style>
    body{font-family:Arial; margin:20px;}
    .messages{
        border:1px solid #ccc;
        height:400px;
        overflow-y:scroll;
        padding:5px;
        margin-bottom:10px;
    }
    input{width:70%; padding:5px;}
    button{padding:5px 10px;}
  </style>
</head>

<body>

<script>
// üîê HARD LOGIN PROTECTION (RUNS FIRST)

const TOKEN = localStorage.getItem("JWT_TOKEN");
const DEPT  = localStorage.getItem("DEPARTMENT");

if(!TOKEN || !DEPT){
    alert("Session expired. Please login again.");
    window.location.href="login.html";
}
</script>


<h2>Official Chat</h2>
<button onclick="logout()">Logout</button><br><br>

<div class="messages" id="messages"></div>

<input id="msg" placeholder="Reply to citizen...">
<button onclick="sendMessage()">Send</button>


<script src="js/crypto-js.js"></script>

<script>

let ws;
let currentReplyToken = null;
const AES_KEY = "my_secret_key_123";

// ‚úÖ WebSocket connection
//ws = new WebSocket(`ws://${location.host}/official?token=${TOKEN}&dept=${DEPT}`);
const protocol = location.protocol === "https:" ? "wss:" : "ws:";
ws = new WebSocket(`${protocol}//${location.host}/official?token=${TOKEN}&dept=${DEPT}`);


ws.onopen = () => {
    console.log("‚úÖ Connected as official");
};

// ws.onmessage = (e) => {

//     const msg = JSON.parse(e.data);

//     // Only handle citizen ‚Üí official
//     if(msg.chatType !== "cto") return;

//     const messagesEl = document.getElementById("messages");

//     let text = msg.message;

//     // Try decrypt
//     try{
//         const bytes = CryptoJS.AES.decrypt(text, AES_KEY);
//         const decrypted = bytes.toString(CryptoJS.enc.Utf8);
//         if(decrypted) text = decrypted;
//     }catch{}

//     messagesEl.innerHTML += `
//         <b>[${msg.department}] Citizen:</b> ${text}<br>
//         <small>Reply Token: ${msg.replyToken}</small><br><br>
//     `;

//     messagesEl.scrollTop = messagesEl.scrollHeight;

//     currentReplyToken = msg.replyToken; // select latest
// };

ws.onmessage = (e) => {

    const msg = JSON.parse(e.data);

    // Only handle cto or otc
    if(msg.chatType !== "cto" && msg.chatType !== "otc") return;

    const messagesEl = document.getElementById("messages");

    let text = msg.message;

    // Try decrypt
    try{
        const bytes = CryptoJS.AES.decrypt(text, AES_KEY);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        if(decrypted) text = decrypted;
    }catch{}

    // üîµ Citizen ‚Üí Official
    if(msg.chatType === "cto"){

        messagesEl.innerHTML += `
            <b>[${msg.department}] Citizen:</b> ${text}<br>
            <small>Reply Token: ${msg.replyToken}</small><br><br>
        `;

        currentReplyToken = msg.replyToken;
    }

    // üü¢ Official ‚Üí Citizen (show own reply)
    if(msg.chatType === "otc"){

    messagesEl.innerHTML += `
        <b>You [${msg.department}]</b>: ${text}
        <span style="color:gray;font-size:0.8em;">
        (${new Date(msg.timestamp).toLocaleTimeString()})
        </span><br><br>
    `;
}

    messagesEl.scrollTop = messagesEl.scrollHeight;
};

function sendMessage(){

    const input = document.getElementById("msg");

    if(!input.value || !currentReplyToken) {
        alert("Select a citizen message first.");
        return;
    }

    const encrypted = CryptoJS.AES.encrypt(input.value, AES_KEY).toString();

    ws.send(JSON.stringify({
        chatType: "otc",                 // ‚úÖ MUST match server
        replyToken: currentReplyToken,   // ‚úÖ MUST match server
        department: DEPT,                // ‚úÖ required
        message: encrypted,
        timestamp: Date.now()
    }));

    input.value="";
}


function logout(){
    localStorage.removeItem("JWT_TOKEN");
    localStorage.removeItem("DEPARTMENT");
    if(ws) ws.close();
    window.location.href="login.html";
}

</script>

</body>
</html>
